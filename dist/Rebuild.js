import{BufferBuilder as e}from"@triforce-heroes/triforce-core/BufferBuilder";import{BufferConsumer as t}from"@triforce-heroes/triforce-core/BufferConsumer";import{nextMultiple as r}from"@triforce-heroes/triforce-core/Number";import{parseEntries as n}from"./parsers/parseEntries.js";import{parseHeader as i}from"./parsers/parseHeader.js";import{parseMessages as s}from"./parsers/parseMessages.js";import{parseSections as o}from"./parsers/parseSections.js";function g(e,t,r,n,i){let{length:s}=e;return e.push(Buffer.from(r.get(n)??t.get(i),"latin1")),e.writeByte(0),s-8}export function rebuild(f,w){let l=new t(f,void 0,1),p=i(l),u=new Map(o(l)),d=u.has("STR1"),{entries:a,count:h,attributesLength:m,attributesBaseLength:I}=n(u.get("INF1"),d),c=d?"STR1":"DAT1",U=new Map(s(u.get(c))),B=[...u.entries()].filter(([e])=>!["INF1",c].includes(e)).reduce((e,[,t])=>e+t.length+8,0),S=new e(1);S.writeString("INF1"),S.writeUnsignedInt32(0),S.writeUnsignedInt16(h),S.writeUnsignedInt16(m+I),S.write(4);let b=new e(1);b.writeString(c),b.writeUnsignedInt32(0),b.writeByte(0);let M=new Map(w);if(d)for(let e=0;e<a.length;e+=2){let[t,r]=a[e],[n]=a[e+1];S.writeUnsignedInt32(r/2),S.writeUnsignedInt16(g(b,U,M,r,t)),S.writeUnsignedInt16(g(b,U,M,r+1,n))}else for(let[e,t,r]of a)S.writeUnsignedInt32(0===e?0:g(b,U,M,t,e)),S.writeUnsignedInt16(t),S.push(r);S.pad(32),b.pad(32);let N=new e(1);for(let[e,t]of(N.writeString("MESG"),N.writeString("bmg1"),N.writeUnsignedInt32(32+S.length+b.length+B),N.writeUnsignedInt32(p.sectionsCount),N.writeByte(p.encoding),N.write(15),u))if("INF1"===e){let e=S.build();e.writeUInt32BE(e.length,4),N.push(e)}else if(e===c){let e=b.build();e.writeUInt32BE(e.length,4),N.push(e)}else N.writeString(e),N.writeUnsignedInt32(r(t.length+8,32)),N.push(t);return N.build()}