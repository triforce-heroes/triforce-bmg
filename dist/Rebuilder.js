import{BufferBuilder as t,nextMultiple as e}from"@triforce-heroes/triforce-core";export class Rebuilder{constructor(t){this.stringsMap=new Map,this.infoEntries=[],this.extraSections=[],this.attributesLength=t,this.infoEntryNull=Buffer.alloc(this.attributesLength+6),this.stringsMap.set(-1,["",Buffer.alloc(this.attributesLength)])}addString(t,e,i){this.stringsMap.set(t,[e,i]),this.infoEntries.push(t)}updateString(t,e){let i=this.stringsMap.get(t);i&&(i[0]=e)}addNull(){this.infoEntries.push(null)}addSection(t,e){this.extraSections.push([t,e])}build(){let i=new t(1),n=new Map;for(let[t,[e]]of this.stringsMap)n.set(t,i.length),i.writeNullTerminatedString(null!=e?Buffer.from(e,"binary"):e);let r=i.build(),s=e(r.length+8,32),l=new t(1);l.writeString("DAT1"),l.writeUnsignedInt32(s),l.push(r),l.write(s-(r.length+8));let h=new t(1);for(let t of this.infoEntries){if(null===t){h.push(this.infoEntryNull);continue}let e=n.get(t),[,i]=this.stringsMap.get(t);h.writeUnsignedInt32(e),h.writeUnsignedInt16(t),h.push(i)}let g=h.build(),u=e(g.length+16,32),o=new t(1);o.writeString("INF1"),o.writeUnsignedInt32(u),o.writeUnsignedInt16(g.length/(this.attributesLength+6)),o.writeUnsignedInt16(this.attributesLength+6),o.write(4),o.push(g),o.write(u-(g.length+16));let a=[],w=this.extraSections.at(-1)?.[0];if(void 0!==w)for(let[i,n]of this.extraSections){let r=w===i,s=new t(1),l=e(n.length+8,32);s.writeString(i),s.writeUnsignedInt32(l),s.push(n),r||s.write(l-(n.length+8)),a.push(s.build())}let f=Buffer.concat(a),d=new t(1);return d.writeString("MESG"),d.writeString("bmg1"),d.writeUnsignedInt32(32+u+s+f.length),d.writeUnsignedInt32(this.extraSections.length+2),d.writeByte(1),d.write(15),Buffer.concat([d.build(),o.build(),l.build(),f])}}